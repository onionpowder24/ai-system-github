# Claude Code 継続用コンテキスト

このドキュメントは、Claude Code を使用してプロジェクトを継続する際に必要な開発経緯と重要な設計思想を記録しています。

## 🎯 プロジェクトの本質

### 核心的価値観
**「その場しのぎではなく本質的解決」**

このプロジェクトの開発において最も重要な価値観です。個別の問題に対するパッチワークではなく、根本原因を特定し、システム全体の品質向上を図ることを重視してきました。

### 主要な技術的ブレークスルー

#### 1. FAISS検索品質問題の本質的解決
**発見した問題**:
- 「Nittoの事業内容は？」という質問に対して、slide_65（役員報酬）が1位選択される異常
- FAISS/BM25検索単体では意味理解が不十分

**解決アプローチ**:
```python
# Before: 機械的な最初の検索結果を使用
rag_knowledge_docs = get_hybrid_knowledge(query=text, top_k=3)
selected_slide = rag_knowledge_docs[0]  # 機械的選択

# After: Gemini知能選択システム
candidates = get_hybrid_knowledge(query=text, top_k=15)  # 広範囲検索
selected_slide = await gemini_intelligent_selection(candidates, query)  # 意味理解選択
```

**重要な学び**: 検索精度の向上は、アルゴリズムの調整ではなく、AI による意味理解の導入で実現された。

#### 2. ハルシネーション検出の完全停止問題
**発見した問題**:
```python
# 問題のあるコード
if False:  # ハルシネーションチェックを完全無効化してテスト
    hal_cls = await check_hallucination(reply, rag_knowledge, rag_qa)
```

**解決策**:
- ハルシネーション検出を復活
- 多段階品質管理システムの構築
- 不適切な応答の自動再検索システム

#### 3. 専門分野制限の撤廃
**問題**: 「データサイエンスが専門だから財務情報は答えられない」
**解決**: 統合報告書全領域対応への方針転換

```python
# Before
"""あなたはNittoのデータサイエンスグループに所属する社員です。
専門分野: データサイエンス"""

# After  
"""あなたはNittoの社員です。（このAIアバターはデータサイエンスグループが開発しました）
専門分野: Nittoグループの全事業領域（統合報告書に記載の全内容）"""
```

## 🏗️ システムアーキテクチャの進化

### 現在の構成
```
質問入力 → FAISS検索(15候補) → Gemini知能選択 → 品質チェック → 音声応答
                ↓                    ↓              ↓
           ハイブリッド検索        意味理解ベース    ハルシネーション検出
           (BM25 + Vector)        最適スライド選択   + 自動再検索
```

### 重要なファイル構造
```
src/
├── gpt.py                 # 主要なロジック（応答生成、品質管理）
├── get_faiss_vector.py    # 検索とGemini選択システム
├── web/api.py            # FastAPI エンドポイント
└── config.py             # 設定管理
```

## 🔍 重要な設計判断と理由

### 1. Gemini知能選択システムの導入理由
**従来の問題**:
- FAISS検索で「事業内容」→「役員報酬スライド」が選ばれる
- キーワードマッチングでは意味の近さを判定できない

**解決方針**:
- 15候補を取得し、Geminiに質問との適合性を評価させる
- 「事業内容なら会社概要スライド、財務なら財務データスライド」という人間的判断をAIに実装

### 2. 多段階品質管理の必要性
**単一チェックの限界**:
- ハルシネーション検出だけでは不十分
- スライド選択の品質も重要

**採用した多段階アプローチ**:
1. 初回検索（FAISS + BM25）
2. 知能選択（Gemini判定）
3. 品質チェック（ハルシネーション検出）
4. 自動再検索（不適切時の代替選択）

### 3. 包括的知識対応への転換
**背景**: 
- 「ナレッジがあるのに答えられない」問題
- データサイエンス専門制限が情報提供を阻害

**解決**: 
- アイデンティティは維持（開発チームクレジット）
- 機能は拡張（全領域対応）

## ⚡ 重要なコード箇所と設計思想

### 1. Gemini知能選択システム (`get_faiss_vector.py`)
```python
async def get_best_knowledge_with_gemini_selection(query, top_k=15):
    """Geminiを使った高精度スライド選択"""
    # 広範囲検索で候補を収集
    top_docs = get_hybrid_knowledge(query=query, top_k=top_k)
    
    # Geminiに適合性を評価させる
    system_prompt = f"""質問に最も適切に回答できるスライドを選択してください。
    判定基準:
    - 売上高・営業利益・業績については財務データを含むスライドを最優先
    - 事業内容については会社概要や事業説明のスライドを優先
    - 具体的な数値データが質問されている場合、その数値を含むスライドを選択
    """
    # ... Gemini判定ロジック
```

### 2. 品質管理システム (`gpt.py`)
```python
# ハルシネーションチェックによる品質管理システム
if not is_greeting:  # 挨拶以外でハルシネーションチェック実行
    hal_cls = await check_hallucination(reply, rag_knowledge, rag_qa)
    if hal_cls != 0:
        # 不適切な応答の場合、再検索を試行
        fallback_docs = get_hybrid_knowledge(query=text, top_k=10)
        alternative_doc = fallback_docs[3]  # 4番目の候補を使用
        # ... 代替応答生成
```

### 3. NGワード処理 (`gpt.py`)
```python
def check_ng(text: str):
    # 関連性の低いキーワードをチェック
    irrelevant_keywords = [
        "関東大震災", "地震", "災害", "戦争", "政治", "選挙", "天気", "料理",
        "芸能", "スポーツ", "映画", "音楽", "ゲーム", "アニメ", "小説"
    ]
    if any(keyword in text for keyword in irrelevant_keywords):
        return True, DEFAULT_NG_MESSAGE
```

## 🎯 テスト駆動開発のアプローチ

### 重要なテストケース
```python
# 必須テスト項目
test_cases = [
    ("Nittoの事業内容は？", "slide_1 or 事業説明スライド"),
    ("2024年度の売上高は？", "slide_19 + 1兆139億円"),
    ("こんにちは", "slide_1 + 挨拶応答"),
    ("データサイエンスグループの活動について", "slide_1強制"),
    ("今日の天気は？", "slide_1 + NGメッセージ"),
]
```

### テスト時の注意点
1. **スライド選択の適切性**: ログで `Gemini選択: スライドX` を確認
2. **ハルシネーション判定**: `ハルシネーション判定: 0` を確認
3. **応答内容の妥当性**: 質問に対する具体的で正確な回答

## 🚨 よくある問題と解決法

### 1. スライド選択が不適切
**症状**: 事業内容質問で役員報酬スライドが選ばれる
**確認**: ログの `Gemini選択:` を確認
**解決**: `get_best_knowledge_with_gemini_selection` の判定基準を調整

### 2. ハルシネーション判定が機能しない
**症状**: `if False:` でチェックが無効化されている
**確認**: `gpt.py` の該当箇所を確認
**解決**: 条件を `if not is_greeting:` に修正

### 3. APIキーエラー
**症状**: Gemini API や Azure Speech Services のエラー
**確認**: `.env` ファイルのAPIキー設定
**解決**: 有効なAPIキーを設定

## 🎨 UI/UX 設計思想

### Unity側の重要な設定
- **AudioSource**: 音声再生用に適切に設定済み
- **VRM Avatar**: 表情とアニメーション対応
- **UI**: 下部の入力欄でシンプルな対話

### Python API側
- **ポート7200**: Unity との通信用
- **CORS設定**: 必要に応じて設定
- **ログ出力**: デバッグ用に詳細ログを実装

## 📚 継続開発時の指針

### 1. 品質第一の原則
- 新機能追加時も品質管理システムを通す
- テストケースを必ず実行
- ログを確認して動作を検証

### 2. 本質的解決の重視
- 問題の根本原因を特定
- その場しのぎの修正を避ける
- システム全体の整合性を保つ

### 3. 拡張性の確保
- 他企業への応用を考慮した設計
- 設定ファイルでの柔軟な調整
- モジュール化された構造

## 🔗 関連リソース

### 重要なファイル
- `CLAUDE.md`: プロジェクト状況の詳細記録
- `system_architecture.html`: システム全体の解説
- `.env.template`: API キー設定テンプレート

### 外部依存
- Google Gemini API
- Azure Speech Services  
- FAISS (Facebook AI Similarity Search)
- Unity VRM

---

**重要**: このプロジェクトは「本質的な問題解決」を重視して開発されました。継続開発時も、この価値観を維持し、根本的な改善を目指してください。